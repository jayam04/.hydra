#!/bin/env python3

import os
import json

jsonfile = 'config.json'
outputfile = 'config.sh'
hydra_folder = os.environ["HYDRA_FOLDER"]

SH_SHEBANG = '#!/bin/bash'
INFO_TO_SHARE = '''
# This file was automatically generated by compile_config.py.
# Don't edit it manually.
# If you want to change any of the variables, edit the config.json file and run scripts/compile_config from HYDRA_FOLDER.
'''

def resolve_var(var_str):
    # Split var_str by /
    var_parts = var_str.split('/')

    new_parts = []
    # For each part in var_parts, check if it starts with $ and replace with variable
    for part in var_parts:
        if part.startswith('$'):
            var_name = part[1:]
            if var_name in os.environ:
                resolved_value = os.environ[var_name]
            else:
                resolved_value = resolved_vars[var_name]
            new_parts.append(resolved_value)
        else:
            new_parts.append(part)
    return '/'.join(new_parts)


# Load JSON
with open(f'{hydra_folder}/{jsonfile}', 'r') as f:
    variables = json.load(f)


resolved_vars = {}
for k, v in variables.items():
    if isinstance(v, str):
        # Handle strings
        resolved_value = resolve_var(v)

    elif isinstance(v, list):
        # Handle lists
        resolved_value = [resolve_var(x) for x in v]

    resolved_vars[k] = resolved_value


# Construct output
output = f'{SH_SHEBANG}\n\n'
output += f'{INFO_TO_SHARE}\n'
for k, v in resolved_vars.items():
    if isinstance(v, list):
        v = ' '.join(v)
        v = f'({v})'
    output += f'export {k}={v}\n'

with open(f"{hydra_folder}/{outputfile}", 'w') as f:
    f.write(output)
